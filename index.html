<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal Weather Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f7fa; color: #333; }
    header { background: #004d99; color: white; padding: 1rem; text-align: center; }
    .section { max-width: 900px; margin: 1rem auto; padding: 1rem; background: white; border-radius: 8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; }
    .slider { display: flex; overflow-x: auto; gap: 0.5rem; padding-bottom: 0.5rem; }
    .card { flex: 0 0 auto; width: 130px; background: #e0e4eb; border-radius: 6px; padding: 0.5rem; text-align: center; }
    .time { font-weight: 600; margin-bottom: 0.5rem; }
    .radar-container { position: relative; text-align: center; }
    .controls { margin-top: 0.5rem; text-align: center; }
    input, button { padding: 0.5rem; margin: 0.5rem 0; width: 100%; }
    button { background: #004d99; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0066cc; }
    #radarMap { width:100%; height:300px; border-radius:6px; }
    #radarSlider { width: 80%; margin: 0.5rem auto; display: block; }
    .weather-icon { position: absolute; top: 5px; right: 5px; z-index: 0; width: 32px; height: 32px; }
    .card { position: relative; /*weather icon positions inside card*/ }
    .card > div {position: relative; z-index: 1;} /*layer text from card creation in <script> to above icon*/
    #cityInput, button[onclick="loadByCity()"] { box-sizing: border-box; }
    #cityInput {display: inline-block; width: 65%; margin: 0.5rem 0.5rem 0.5rem 0; vertical-align: middle;  }
    button[onclick="loadByCity()"] {display: inline-block; width: calc(30% - 0.5rem); margin: 0.5rem 0 0.5rem 0; vertical-align: middle;}
    /*stack for small screens*/
    @media (max-width: 480px) { #cityInput, button[onclick="loadByCity()"] { display: block; width: 100%; margin-right: 0;}  }
  </style>
</head>

<body>
  <header><h1>Personal Weather Dashboard</h1></header>
  
  <div class="section">
    <h2>City</h2>
    <input id="cityInput" type="text" placeholder="Enter City Name" />
    <button onclick="loadByCity()">Enter</button>
  </div>

  <div class="section">
    <h2>Hourly Forecast</h2>
    <div id="hourlySlider" class="slider"></div>
  </div>

  <div class="section">
    <h2>7-Day Forecast</h2>
    <div id="dailySlider" class="slider"></div>
  </div>

  <div class="section">
    <h2>Radar</h2>
    <div class="radar-container">
      <div id="radarMap"></div>
      <div class="controls">
        <div id="radarTime" style="margin-bottom: 0.5rem; font-weight: bold;">--:--</div>
        <input type="range" id="radarSlider" min="0" max="2" value="0">
        <button onclick="startRadar()">Play</button>
        <button onclick="stopRadar()">Stop</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

<script>
  let radarMap, radarLayer, radarInterval, frameIndex=0, frames=[], times=[];

  //Had to hard code abreviations
  const US_STATE_BY_ABBR = {
    AL:"Alabama", AK:"Alaska", AZ:"Arizona", AR:"Arkansas", CA:"California",
    CO:"Colorado", CT:"Connecticut", DE:"Delaware", FL:"Florida", GA:"Georgia",
    HI:"Hawaii", ID:"Idaho", IL:"Illinois", IN:"Indiana", IA:"Iowa",
    KS:"Kansas", KY:"Kentucky", LA:"Louisiana", ME:"Maine", MD:"Maryland",
    MA:"Massachusetts", MI:"Michigan", MN:"Minnesota", MS:"Mississippi", MO:"Missouri",
    MT:"Montana", NE:"Nebraska", NV:"Nevada", NH:"New Hampshire", NJ:"New Jersey",
    NM:"New Mexico", NY:"New York", NC:"North Carolina", ND:"North Dakota", OH:"Ohio",
    OK:"Oklahoma", OR:"Oregon", PA:"Pennsylvania", RI:"Rhode Island", SC:"South Carolina",
    SD:"South Dakota", TN:"Tennessee", TX:"Texas", UT:"Utah", VT:"Vermont",
    VA:"Virginia", WA:"Washington", WV:"West Virginia", WI:"Wisconsin", WY:"Wyoming",
    DC:"District of Columbia"
  };
  const COUNTRY_ALIASES = { UK:"GB" };

  function parseLocationInput(raw) {
    //accept: "City", "City ST", "City, ST", "City State", "City, State", also country codes/names
    const input = raw.trim().replace(/\s{2,}/g, " ");
    if (!input) return { cityQuery: "", stateName: null, countryCode: null };

    //split by comma if present, else by spaces
    let cityPart = input, regionPart = "";

    if (input.includes(",")) {
      const parts = input.split(",").map(s => s.trim()).filter(Boolean);
      cityPart = parts.shift() || "";
      regionPart = (parts.join(" ") || "").trim(); //can contain "State" and/or "Country"
    } else {
      //token is region (state/country); the rest is city. Reddit note
      const tokens = input.split(" ");
      if (tokens.length > 1) {
        regionPart = tokens.pop();
        cityPart = tokens.join(" ");
      }
    }

    //try to detect state and/or country from regionPart above
    let stateName = null, countryCode = null;

    if (regionPart) {
      const regionTokens = regionPart.split(/\s+/);
      //check two-letter upper-case (state or country)
      const maybeTwo = regionTokens[0].toUpperCase();

      if (US_STATE_BY_ABBR[maybeTwo]) {
        stateName = US_STATE_BY_ABBR[maybeTwo];
        countryCode = "US";
      } else if (maybeTwo.length === 2) {
        countryCode = COUNTRY_ALIASES[maybeTwo] || maybeTwo;
      } else {
        //check full state names (case-insensitive)
        const matchState = Object.values(US_STATE_BY_ABBR).find(
          s => s.toLowerCase() === regionPart.toLowerCase()
        );
        if (matchState) {
          stateName = matchState;
          countryCode = "US";
        } else {
          countryCode = null;
        }
      }
    }
    return { cityQuery: cityPart.trim(), stateName, countryCode };
  }

  function rankResult(r, opts) {
    const { stateName, countryCode, preferCountry } = opts;
    let score = 0;

    //exact state match gets top priority
    if (stateName && r.admin1 && r.admin1.toLowerCase() === stateName.toLowerCase()) score += 1000;

    //country match high priority
    if (countryCode && r.country_code === countryCode) score += 500;

    //no country, prefer user's region (timezones)
    if (!countryCode && preferCountry && r.country_code === preferCountry) score += 120;

    if (r.feature_code && /^PPL/.test(r.feature_code)) score += 20;

    score += (r.population || 0) / 1_000_000;
    //ChatGPT help with scoring system
    return score;
  }

  async function loadByCity() {
    const raw = document.getElementById('cityInput').value.trim();
    if (!raw) return; //do nothing on empty input

    const { cityQuery, stateName, countryCode } = parseLocationInput(raw);
    if (!cityQuery) return;

    //prefer US if the browser timezone is in the Americas and the user didn’t type a country
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
    const preferCountry = (!countryCode && /^America\//.test(tz)) ? "US" : null;

    //multiple candidates, filter/rank client-side reddit note + w3 school
    const geo = await fetch(
      `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityQuery)}&count=10&language=en`
    ).then(r => r.json()).catch(() => null);

    if (!geo || !geo.results || geo.results.length === 0) {
      alert('City not found. Try adding a state or country.');
      return;
    }

    //country/state if user specified
    let candidates = geo.results.slice();

    if (countryCode) {
      candidates = candidates.filter(r => r.country_code === countryCode) || candidates;
    }
    if (stateName) {
      const stateMatches = candidates.filter(r => r.admin1 && r.admin1.toLowerCase() === stateName.toLowerCase());
      if (stateMatches.length) candidates = stateMatches;
    }

    //rank remaining candidates
    candidates.sort((a, b) =>
      rankResult(b, { stateName, countryCode, preferCountry }) - rankResult(a, { stateName, countryCode, preferCountry })
    );

    const match = candidates[0];
    const { latitude, longitude } = match;
    const displayName = match.name;
    //API
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}` +
            `&hourly=temperature_2m,precipitation_probability,relative_humidity_2m,apparent_temperature,weathercode` +
            `&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode` +
            `&past_hours=2&forecast_hours=4&timezone=auto&temperature_unit=fahrenheit`;

    const data = await fetch(url).then(r => r.json());
    renderHourly(data.hourly);
    renderDaily(data.daily);
    setupRadarMap(latitude, longitude, displayName);
  }

  //icon codes - ChatGPT help with linking to API. Could not find weather code.
  const weatherIcons = {
    0: "/images/sunny.png",
    1: "/images/partly_cloudy.png",
    2: "/images/partly_cloudy.png",
    3: "/images/cloudy.png",
    45: "/images/fog.png",
    48: "/images/fog.png",
    51: "/images/drizzle.png",
    53: "/images/drizzle.png",
    55: "/images/drizzle.png",
    61: "/images/rain.png",
    63: "/images/rain.png",
    65: "/images/rain.png",
    71: "/images/snow.png",
    73: "/images/snow.png",
    75: "/images/snow.png",
    77: "/images/snow.png",
    80: "/images/showers.png",
    81: "/images/showers.png",
    82: "/images/showers.png",
    95: "/images/thunder.png",
    96: "/images/thunder.png",
    99: "/images/thunder.png"
  };
  
  function renderHourly(h) {
  const dv = document.getElementById('hourlySlider'); 
  dv.innerHTML = '';
  h.time.forEach((t,i) => {
    const ts = new Date(t).toLocaleString('en-US',{weekday:'short', hour:'numeric', hour12:true});
    const temp = Math.round(h.temperature_2m[i]) + '°F';
    const rain = h.precipitation_probability[i] + '%';
    const hi = Math.round(h.apparent_temperature[i]) + '°F';
    const icon = weatherIcons[h.weathercode[i]] || "default.png";
    //organize card
    dv.append(Object.assign(document.createElement('div'), {
      className: 'card',
      innerHTML: `
        <img src="${icon}" class="weather-icon" />
        <div class="time">${ts}</div>
        <div>${temp}</div>
        <div>Rain: ${rain}</div>
        <div>Feels: ${hi}</div>`
    }));
  });
}

  function renderDaily(d) {
  const dv = document.getElementById('dailySlider'); 
  dv.innerHTML = '';
  d.time.forEach((dstr,i) => {
    const day = new Date(dstr).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const hi = Math.round(d.temperature_2m_max[i]) + '°F';
    const lo = Math.round(d.temperature_2m_min[i]) + '°F';
    const rain = d.precipitation_probability_max[i] + '%';
    const icon = weatherIcons[d.weathercode[i]] || "default.png";
    //organize card
    dv.append(Object.assign(document.createElement('div'), {
      className: 'card',
      innerHTML: `
        <img src="${icon}" class="weather-icon" />
        <div class="time">${day}</div>
        <div>Hi: ${hi}</div>
        <div>Lo: ${lo}</div>
        <div>Rain: ${rain}</div>`
    }));
  });
}

  function setupRadarMap(lat, lon, label) {
    if (!radarMap) {
      radarMap = L.map('radarMap').setView([lat, lon], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(radarMap);
    }

    radarMap.setView([lat, lon], 8);
    if (window.cityMarker) radarMap.removeLayer(window.cityMarker);
    window.cityMarker = L.marker([lat, lon]).addTo(radarMap).bindPopup(label).openPopup();

    const now = Math.floor(Date.now()/1000);
    times = [];
    for (let i=-2; i<=0; i++) { times.push(now + i*3600); }

    frames = times.map(t => {
      const date = new Date(t*1000);
      const yyyy = date.getUTCFullYear();
      const mm = String(date.getUTCMonth()+1).padStart(2,'0');
      const dd = String(date.getUTCDate()).padStart(2,'0');
      const hh = String(date.getUTCHours()).padStart(2,'0');

      return L.tileLayer(`https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q/{z}/{x}/{y}.png?year=${yyyy}&month=${mm}&day=${dd}&hour=${hh}`, {
        opacity: 0.6,
        attribution: 'Radar © Iowa State University / NWS'
      });
    });

    frameIndex = 0;
    document.getElementById('radarSlider').max = frames.length - 1;
    if (radarLayer) radarMap.removeLayer(radarLayer);
    radarLayer = frames[frameIndex].addTo(radarMap);
    updateRadarTime();

    const slider = document.getElementById('radarSlider');
    slider.value = frameIndex;
    slider.oninput = function() {
      if (radarInterval) stopRadar();
      radarMap.removeLayer(radarLayer);
      frameIndex = parseInt(this.value, 10);
      radarLayer = frames[frameIndex].addTo(radarMap);
      updateRadarTime();
    };
  }

  function updateRadarTime() {
    const time = new Date(times[frameIndex]*1000);
    document.getElementById('radarTime').innerText =
      time.toLocaleString('en-US', {weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'numeric', hour12:true});
    document.getElementById('radarSlider').value = frameIndex;
  }

  function startRadar() {
    if (radarInterval) return;
    radarInterval = setInterval(()=>{
      radarMap.removeLayer(radarLayer);
      frameIndex = (frameIndex + 1) % frames.length;
      radarLayer = frames[frameIndex].addTo(radarMap);
      updateRadarTime();
    }, 1000);
  }

  function stopRadar() {
    clearInterval(radarInterval);
    radarInterval = null;
  }
</script>

</body>
</html>

